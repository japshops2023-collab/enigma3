<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE SYSTEM - CLEAN EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0a0a0a; color: #00ff41; }
        .code-font { font-family: 'Courier Prime', monospace; }
        textarea { background-color: #111 !important; color: #00ff41 !important; border-color: #004411 !important; }
        textarea:focus { border-color: #00ff41 !important; outline: none; }
        button { transition: all 0.2s; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-2xl mt-10 p-6 bg-black border border-green-900 rounded-lg shadow-2xl">
        <h1 class="text-2xl font-bold text-center mb-6 tracking-widest text-green-500">SYSTEM SECURE V.23</h1>

        <!-- Daily Token Display -->
        <div class="mb-6 p-3 border border-green-800 rounded bg-gray-900 text-center">
            <span class="text-xs text-green-700">TOKEN ประจำวัน:</span>
            <div id="tokenDisplay" class="text-xl font-bold text-yellow-500 code-font">...</div>
        </div>

        <!-- Input Section -->
        <div class="mb-4">
            <label class="block text-xs font-bold mb-1 text-green-800">INPUT (ข้อความต้นฉบับ)</label>
            <textarea id="inputText" rows="4" class="w-full p-3 rounded border code-font" placeholder="พิมพ์ข้อความหรือตัวเลขที่นี่..."></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-2 mb-4">
            <button onclick="runEncrypt()" class="flex-1 bg-green-900 hover:bg-green-700 text-white font-bold py-2 rounded border border-green-500">
                LOCK (เข้ารหัส)
            </button>
            <button onclick="runDecrypt()" class="flex-1 bg-blue-900 hover:bg-blue-700 text-white font-bold py-2 rounded border border-blue-500">
                UNLOCK (ถอดรหัส)
            </button>
            <button onclick="clearAll()" class="px-4 bg-red-900 hover:bg-red-700 text-white rounded border border-red-500">
                CLR
            </button>
        </div>

        <!-- Output Section -->
        <div>
            <label class="block text-xs font-bold mb-1 text-green-800">OUTPUT (ผลลัพธ์)</label>
            <textarea id="outputText" rows="6" readonly class="w-full p-3 rounded border code-font break-all" placeholder="รหัสจะแสดงที่นี่..."></textarea>
            <button onclick="copyResult()" class="mt-2 w-full text-xs text-green-600 hover:text-green-400 py-1">คัดลอกรหัสไปยังคลิปบอร์ด</button>
        </div>
    </div>

    <script>
        // --- การตั้งค่าคีย์พื้นฐาน ---
        const BASE_KEYS = [1211, 19050, 5000, 30000];
        const ROMAN_SYMBOLS = ['I', 'V', 'X', 'L', 'C', 'D', 'M'];
        const ALPHA_MAP = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

        // --- ระบบคำนวณคีย์ตามวัน (Daily Key) ---
        function getDailyOffset() {
            const today = new Date();
            const day = today.getDate();
            return (day * 7) + 3; // สูตรคำนวณ Offset ประจำวัน
        }

        function getDailyKeys() {
            const offset = getDailyOffset();
            return BASE_KEYS.map(k => k + offset);
        }

        function getDailyHeader() {
            const today = new Date();
            const day = today.getDate();
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const char = alphabet[day % 26];
            return `D${day}${char}`;
        }

        // --- ระบบจัดการเลขโรมัน ---
        function toRoman(num) {
            if (num <= 0 || num > 100) return "";
            const lookup = {C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};
            let roman = '';
            for (let i in lookup) {
                while (num >= lookup[i]) { roman += i; num -= lookup[i]; }
            }
            return roman;
        }

        function fromRoman(roman) {
            const lookup = {I:1,V:5,X:10,L:50,C:100,D:500,M:1000};
            let num = 0;
            for (let i = 0; i < roman.length; i++) {
                let curr = lookup[roman[i]];
                let next = lookup[roman[i+1]];
                if (next && curr < next) { num -= curr; } else { num += curr; }
            }
            return num;
        }

        // ตัวคั่นสุ่ม (Delimiter)
        function getDelim(i) {
            let val = (i % 90);
            return val % 2 === 0 ? (99 - val / 2).toString() : (10 + Math.floor(val / 2)).toString();
        }

        // --- ฟังก์ชันหลัก: เข้ารหัส ---
        function runEncrypt() {
            const input = document.getElementById('inputText').value;
            if (!input) return;

            const keys = getDailyKeys();
            let header = getDailyHeader();
            let output = header + " ";
            let gi = 0;

            const tokens = input.split(/(\d+)/); // แยกตัวเลขออกจากตัวหนังสือ

            tokens.forEach(token => {
                if (!token) return;

                if (/^\d+$/.test(token)) {
                    // กรณีเป็นตัวเลข: แปลงเป็นโรมันก่อน
                    let num = parseInt(token, 10);
                    let roman = toRoman(num);
                    for (let char of roman) {
                        let idx = ROMAN_SYMBOLS.indexOf(char);
                        if (idx !== -1) {
                            output += (keys[3] + idx).toString() + getDelim(gi++);
                        }
                    }
                } else {
                    // กรณีเป็นตัวอักษรปกติ
                    for (let i = 0; i < token.length; i++) {
                        const char = token[i];
                        const code = char.charCodeAt(0);
                        let ev = "", isEnc = false;

                        if (code >= 3585 && code <= 3630) { // ภาษาไทย พยัญชนะ
                            ev = "0" + (code - 3585 + keys[0]); isEnc = true;
                        } else if (code >= 3631 && code <= 3675) { // ภาษาไทย สระ
                            ev = (code - 3631 + keys[1]); isEnc = true;
                        } else if ((code >= 65 && code <= 90) || (code >= 97 && code <= 122)) { // อังกฤษ
                            let off = (code >= 97) ? (code - 97 + 26) : (code - 65);
                            ev = "0" + (keys[2] + off); isEnc = true;
                        }

                        if (isEnc) {
                            output += ev + getDelim(gi++);
                        } else {
                            output += char;
                        }
                    }
                }
            });
            document.getElementById('outputText').value = output;
        }

        // --- ฟังก์ชันหลัก: ถอดรหัส ---
        function runDecrypt() {
            let input = document.getElementById('inputText').value;
            if (!input) return;

            // ตรวจสอบส่วนหัว (DxxX)
            const match = input.match(/^(D\d{1,2}[A-Z])\s?/);
            const keys = getDailyKeys(); // ใช้คีย์วันนี้เป็นพื้นฐาน (ถ้าถอดรหัสของวันอื่นต้องแก้นิดหน่อย)
            
            if (match) input = input.substring(match[0].length);

            let result = "";
            let romanBuf = "";
            let i = 0;

            while (i < input.length) {
                const char = input[i];
                if (char === ' ') {
                    if (romanBuf) { result += fromRoman(romanBuf); romanBuf = ""; }
                    result += ' '; i++; continue;
                }

                let chunk = input.substr(i, 5);
                if (/^\d{5}$/.test(chunk)) {
                    let val = parseInt(chunk, 10);
                    let decoded = "";
                    let isRoman = false;

                    // ตรวจสอบว่าเป็นโซนโรมันหรือไม่ (Keys[3])
                    if (val >= keys[3] && val < keys[3] + 10) {
                        decoded = ROMAN_SYMBOLS[val - keys[3]];
                        isRoman = true;
                    } 
                    // ภาษาไทย / อังกฤษ
                    else if (val >= keys[0] && val < keys[0] + 100) {
                        decoded = String.fromCharCode(val - keys[0] + 3585);
                    } else if (val >= keys[1] && val < keys[1] + 100) {
                        decoded = String.fromCharCode(val - keys[1] + 3631);
                    } else if (val >= keys[2] && val < keys[2] + 100) {
                        let off = val - keys[2];
                        decoded = String.fromCharCode(off < 26 ? off + 65 : off - 26 + 97);
                    }

                    if (isRoman) {
                        romanBuf += decoded;
                    } else {
                        if (romanBuf) { result += fromRoman(romanBuf); romanBuf = ""; }
                        result += decoded;
                    }
                    i += 7; // ข้ามรหัส 5 หลัก + ตัวคั่น 2 หลัก
                } else {
                    if (romanBuf) { result += fromRoman(romanBuf); romanBuf = ""; }
                    result += char; i++;
                }
            }
            if (romanBuf) result += fromRoman(romanBuf);
            document.getElementById('outputText').value = result;
        }

        function clearAll() {
            document.getElementById('inputText').value = "";
            document.getElementById('outputText').value = "";
        }

        function copyResult() {
            const out = document.getElementById('outputText');
            out.select();
            document.execCommand('copy');
            alert("คัดลอกรหัสเรียบร้อยแล้ว");
        }

        // เริ่มต้นระบบ
        document.getElementById('tokenDisplay').innerText = getDailyHeader();
    </script>
</body>
</html>